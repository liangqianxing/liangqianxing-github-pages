{% extends '_layout.njk' %}
{% import '_macro/sidebar.njk' as sidebar_template with context %}

{% block title %}
  {%- set page_title_suffix = ' | ' + title %}
  {{ (page.title or __('title.category')) + page_title_suffix }}
{% endblock %}

{% block class %}page posts-expand category-graph-page{% endblock %}

{% block content %}
  {%- set category_list = site.categories.toArray() %}
  {%- set category_count = category_list | length %}
  {%- set total_post_count = 0 %}
  {%- for category_item in category_list %}
    {%- set total_post_count = total_post_count + category_item.length %}
  {%- endfor %}
  {%- set avg_posts = 0 %}
  {%- if category_count > 0 %}
    {%- set avg_posts = total_post_count / category_count %}
  {%- endif %}
  <div class="post-block" lang="{{ page.lang }}">
    {%- if page.header !== false %}
      {%- include '_partials/page/page-header.njk' -%}
    {%- endif %}
    <div class="post-body category-graph-body">
      <section class="graph-lite-guides" aria-label="操作提示">
        <p class="graph-lite-text">拖拽节点调整布局，滚轮缩放，点击分类节点可跳转到该分类，双击空白处复位。</p>
        <div class="graph-lite-stats">
          <span>{{ category_count }} 个分类</span>
          <span>{{ total_post_count }} 篇文章</span>
        </div>
      </section>
      <div class="category-graph-grid">
        <section class="graph-panel graph-panel--full">
          <header class="graph-panel__header">
            <p class="graph-panel__eyebrow">Knowledge Map</p>
            <h2 class="graph-panel__title">{{ page.title or __('title.category') }}</h2>
            <p class="graph-panel__desc">以知识图谱快速浏览分类，节点大小对应文章数。</p>
            <div class="graph-selection" id="graphSelectionInfo">
              <span>请选择一个分类节点。</span>
            </div>
          </header>
          <div class="graph-canvas">
            <svg id="categoryGraph" role="img" aria-label="{{ page.title or __('title.category') }}"></svg>
          </div>
        </section>
        <aside class="graph-preview" id="categoryDetails">
          <div class="graph-preview__header">
            <p class="graph-panel__eyebrow">Preview</p>
            <h3 id="graphListTitle" data-default-title="{{ page.title or __('title.category') }} · 预览">{{ page.title or __('title.category') }} · 预览</h3>
            <p id="graphListSub" data-default-sub="选择左侧分类节点查看文章摘要。">选择左侧分类节点查看文章摘要。</p>
            <a id="graphVisitLink" class="graph-preview__link is-disabled" href="javascript:void(0)" aria-disabled="true">访问分类页面</a>
          </div>
          <ul id="categoryPosts" class="graph-post-items"></ul>
        </aside>
      </div>
      <div id="categoryGraphData"
           class="graph-data"
           data-root-title="{{ (page.title or __('title.category')) | escape }}"
           hidden>
        {%- for category in category_list %}
          <section class="graph-category"
                   data-name="{{ category.name | escape }}"
                   data-slug="{{ category.slug | escape }}"
                   data-count="{{ category.length }}"
                   data-url="{{ url_for(category.path) | escape }}">
            {%- for post in category.posts.toArray() %}
              <a class="graph-category-post"
                 data-title="{{ post.title | escape }}"
                 data-url="{{ url_for(post.path) | escape }}"
                 data-date="{{ date(post.date, config.date_format) | escape }}"></a>
            {%- endfor %}
          </section>
        {%- endfor %}
      </div>
    </div>
  </div>
  {%- include '_partials/page/breadcrumb.njk' -%}

  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (!window.d3) return;

      const graphDataEl = document.getElementById('categoryGraphData');
      const canvasEl = document.querySelector('.graph-canvas');
      const svgEl = document.getElementById('categoryGraph');
      const selectionEl = document.getElementById('graphSelectionInfo');
      const postsListEl = document.getElementById('categoryPosts');
      const listTitleEl = document.getElementById('graphListTitle');
      const listSubEl = document.getElementById('graphListSub');
      const visitLinkEl = document.getElementById('graphVisitLink');

      if (!graphDataEl || !canvasEl || !svgEl) {
        return;
      }

      const colorVars = getComputedStyle(document.documentElement);
      const accentColor = colorVars.getPropertyValue('--accent-primary').trim() || '#3a7bd5';
      const accentSoft = colorVars.getPropertyValue('--muted-bg').trim() || 'rgba(58,123,213,.15)';

      const categories = Array.from(graphDataEl.querySelectorAll('.graph-category')).map(function(categoryEl, index) {
        const posts = Array.from(categoryEl.querySelectorAll('.graph-category-post')).map(function(postEl) {
          return {
            title: postEl.dataset.title,
            url: postEl.dataset.url,
            date: postEl.dataset.date
          };
        });
        const slug = categoryEl.dataset.slug || ('category-' + index);
        const url = categoryEl.dataset.url || '';

        return {
          id: slug,
          name: categoryEl.dataset.name || slug,
          count: parseInt(categoryEl.dataset.count || posts.length || 0, 10),
          posts: posts,
          url: url
        };
      }).filter(function(category) {
        return category.name;
      });

      if (!categories.length) {
        canvasEl.innerHTML = '<p class="graph-empty">当前还没有分类可以展示，写一篇文章后再来看看吧。</p>';
        return;
      }

      const rootTitle = graphDataEl.dataset.rootTitle || '知识图谱';
      const totalCategories = categories.length;
      const totalPosts = categories.reduce(function(total, category) {
        return total + category.count;
      }, 0);
      const defaultListTitle = listTitleEl ? listTitleEl.dataset.defaultTitle || listTitleEl.textContent : '';
      const defaultListSub = listSubEl ? listSubEl.dataset.defaultSub || listSubEl.textContent : '';

      const nodes = [{
        id: 'graph-root',
        name: rootTitle,
        type: 'root',
        count: totalPosts
      }].concat(categories.map(function(category) {
        category.type = 'category';
        return category;
      }));

      const links = categories.map(function(category) {
        return {
          source: 'graph-root',
          target: category.id
        };
      });

      const svg = window.d3.select(svgEl);

      function resizeCanvas() {
        const width = canvasEl.clientWidth;
        const height = canvasEl.clientHeight || 500;
        svg.attr('viewBox', '0 0 ' + width + ' ' + height);
        return { width, height };
      }

      let { width, height } = resizeCanvas();

      const link = svg.append('g')
        .attr('class', 'graph-links')
        .selectAll('line')
        .data(links)
        .enter()
        .append('line');

      const node = svg.append('g')
        .attr('class', 'graph-nodes')
        .selectAll('g')
        .data(nodes)
        .enter()
        .append('g')
        .attr('class', function(d) { return 'graph-node graph-node--' + d.type; })
        .call(
          window.d3.drag()
            .on('start', dragstarted)
            .on('drag', dragged)
            .on('end', dragended)
        );

      node.append('circle')
        .attr('r', function(d) {
          if (d.type === 'root') return 50;
          return 24 + Math.min(26, (d.count || 1) * 2);
        })
        .style('fill', function(d) {
          return d.type === 'root' ? accentColor : accentSoft;
        })
        .style('stroke', accentColor);

      node.append('text')
        .text(function(d) { return d.name; })
        .attr('text-anchor', 'middle')
        .attr('dy', '.35em');

      node.on('click', function(event, datum) {
        node.classed('is-active', function(d) {
          return d.id === datum.id;
        });
        if (datum.type === 'category') {
          updateSelection(datum);
        } else {
          resetSelection();
        }
      });

      const simulation = window.d3.forceSimulation(nodes)
        .force('link', window.d3.forceLink(links).id(function(d) { return d.id; }).distance(180))
        .force('charge', window.d3.forceManyBody().strength(-360))
        .force('center', window.d3.forceCenter(width / 2, height / 2))
        .force('collision', window.d3.forceCollide().radius(function(d) {
          return d.type === 'root' ? 70 : 45;
        }))
        .on('tick', ticked);

      function ticked() {
        link
          .attr('x1', function(d) { return d.source.x; })
          .attr('y1', function(d) { return d.source.y; })
          .attr('x2', function(d) { return d.target.x; })
          .attr('y2', function(d) { return d.target.y; });

        node
          .attr('transform', function(d) {
            return 'translate(' + d.x + ',' + d.y + ')';
          });
      }

      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }

      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }

      function updateSelection(category) {
        const countText = category.count ? category.count + ' 篇文章' : '暂无文章';
        if (selectionEl) {
          selectionEl.innerHTML = '<span>当前分类：' + category.name + '</span><span>' + countText + '</span>';
        }
        if (listTitleEl) {
          listTitleEl.textContent = category.name + ' · 预览';
        }
        if (listSubEl) {
          const latestDate = category.posts && category.posts.length ? category.posts[0].date || '—' : '—';
          listSubEl.textContent = category.count ? category.count + ' 篇文章 · 最新发布时间：' + latestDate : '该分类还没有文章。';
        }
        if (visitLinkEl) {
          if (category.url) {
            visitLinkEl.href = category.url;
            visitLinkEl.classList.remove('is-disabled');
            visitLinkEl.setAttribute('aria-disabled', 'false');
          } else {
            visitLinkEl.href = 'javascript:void(0)';
            visitLinkEl.classList.add('is-disabled');
            visitLinkEl.setAttribute('aria-disabled', 'true');
          }
        }
        renderPosts(category.posts, '这个分类还没有文章。');
      }

      function renderPosts(posts, emptyMessage) {
        if (!postsListEl) return;
        postsListEl.innerHTML = '';
        if (!posts || !posts.length) {
          const emptyItem = document.createElement('li');
          emptyItem.className = 'graph-post-item graph-post-item--empty';
          emptyItem.textContent = emptyMessage || '这个分类还没有文章。';
          postsListEl.appendChild(emptyItem);
          return;
        }
        posts.slice(0, 5).forEach(function(post) {
          const item = document.createElement('li');
          item.className = 'graph-post-item';
          const linkEl = document.createElement('a');
          linkEl.href = post.url;
          linkEl.textContent = post.title;
          linkEl.rel = 'bookmark';
          const metaEl = document.createElement('span');
          metaEl.textContent = post.date || '';
          item.appendChild(linkEl);
          item.appendChild(metaEl);
          postsListEl.appendChild(item);
        });
      }

      function resetSelection() {
        node.classed('is-active', function(d) { return d.id === 'graph-root'; });
        if (selectionEl) {
          selectionEl.innerHTML = '<span>请选择一个分类节点。</span>';
        }
        if (listTitleEl) {
          listTitleEl.textContent = defaultListTitle;
        }
        if (listSubEl) {
          listSubEl.textContent = defaultListSub;
        }
        if (visitLinkEl) {
          visitLinkEl.href = 'javascript:void(0)';
          visitLinkEl.classList.add('is-disabled');
          visitLinkEl.setAttribute('aria-disabled', 'true');
        }
        renderPosts([], '选择分类后会显示对应文章列表。');
      }

      resetSelection();

      let resizeTimer = null;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
          const size = resizeCanvas();
          width = size.width;
          height = size.height;
          simulation.force('center', window.d3.forceCenter(width / 2, height / 2));
          simulation.alpha(0.6).restart();
        }, 200);
      });
    });
  </script>
{% endblock %}

{% block sidebar %}
  {{ sidebar_template.render(false) }}
{% endblock %}
